<style>
  #lang-toggle {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 14px;
    margin: auto 4px;
  }

  #lang-toggle svg {
    width: 24px;
    height: 18px;
  }
</style>

<script>
  (function () {
    const STORAGE_KEY = "pref-lang";
    const SUPPORTED_LANGS = ["en", "zh-CN"];
    const FALLBACK_LANG = "en";

    const translations = {
      en: {
        lang_toggle_label: "EN",
        lang_toggle_title: "Switch language",
        toggle_theme: "Toggle theme",
        nav_home: "Home",
        home_welcome: "Welcome to my blog.",
        home_tagline: "where old memories meet new adventures.",
        go_top: "Go to Top"
      },
      "zh-CN": {
        lang_toggle_label: "中",
        lang_toggle_title: "切换语言",
        toggle_theme: "切换主题",
        nav_home: "首页",
        home_welcome: "欢迎来到我的博客。",
        home_tagline: "在这里，旧日回忆与新冒险相遇。",
        go_top: "回到顶部"
      }
    };

    function normalizeLang(raw) {
      if (!raw) return FALLBACK_LANG;
      const lowered = String(raw).toLowerCase();
      if (lowered === "zh" || lowered === "zh-cn" || lowered.startsWith("zh-")) {
        return "zh-CN";
      }
      if (lowered.startsWith("en")) {
        return "en";
      }
      return FALLBACK_LANG;
    }

    function getStoredLang() {
      try {
        return localStorage.getItem(STORAGE_KEY);
      } catch (err) {
        return null;
      }
    }

    function storeLang(lang) {
      try {
        localStorage.setItem(STORAGE_KEY, lang);
      } catch (err) {
        // Ignore storage errors in strict browser modes.
      }
    }

    function detectInitialLang() {
      const stored = normalizeLang(getStoredLang());
      if (SUPPORTED_LANGS.includes(stored)) return stored;
      const browser = normalizeLang(navigator.language);
      return SUPPORTED_LANGS.includes(browser) ? browser : FALLBACK_LANG;
    }

    const state = { lang: detectInitialLang() };

    function getText(key) {
      return (
        (translations[state.lang] && translations[state.lang][key]) ||
        (translations[FALLBACK_LANG] && translations[FALLBACK_LANG][key]) ||
        key
      );
    }

    function setLang(nextLang) {
      const normalized = normalizeLang(nextLang);
      const finalLang = SUPPORTED_LANGS.includes(normalized) ? normalized : FALLBACK_LANG;
      state.lang = finalLang;
      storeLang(finalLang);
      document.documentElement.setAttribute("lang", finalLang);
      document.dispatchEvent(new CustomEvent("i18n:change", { detail: { lang: finalLang } }));
    }

    window.getText = getText;
    window.getPreferredLang = function () {
      return state.lang;
    };
    window.setPreferredLang = setLang;
    window.getSupportedLangs = function () {
      return SUPPORTED_LANGS.slice();
    };

    document.documentElement.setAttribute("lang", state.lang);
  })();
</script>
